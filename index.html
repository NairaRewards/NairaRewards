<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NSUK Secure Login</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
    <style>
        :root { --nsuk: #004d40; --gold: #ffc107; --white: #ffffff; --success: #2ecc71; --error: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; transition: background 0.3s; overflow-x: hidden; }
        
        .container { width: 100%; max-width: 450px; text-align: center; padding: 20px; z-index: 10; box-sizing: border-box; }
        
        /* SLEEK 10PX RING */
        .video-wrapper { 
            width: 280px; height: 280px; margin: 0 auto; 
            border: 10px solid var(--white); 
            border-radius: 50%; overflow: hidden; position: relative; 
            box-shadow: 0 0 40px 10px rgba(255, 255, 255, 0.7);
            transition: 0.4s ease;
        }
        
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); filter: brightness(1.1) contrast(1.1); }
        #status { margin-top: 25px; font-weight: 800; color: var(--gold); text-transform: uppercase; min-height: 1.5em; font-size: 1.1rem; letter-spacing: 1px; }

        /* LOGIN CARD */
        #login-card { 
            background: white; color: #333; padding: 35px; border-radius: 30px; 
            width: 92%; max-width: 400px; margin: 20px 0; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); 
            border: 3px solid var(--nsuk); text-align: left;
            box-sizing: border-box;
        }
        
        label { display: block; margin-top: 15px; font-weight: 700; color: var(--nsuk); font-size: 0.9rem; }
        input { width: 100%; padding: 15px; margin: 8px 0; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 1rem; color: #000; font-weight: 600; }
        
        .btn { background: var(--nsuk); color: white; border: none; padding: 18px; border-radius: 15px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; font-size: 1.1rem; transition: 0.3s; }
        .btn:disabled { background: #111; color: #444; border: 1px solid #222; cursor: not-allowed; }

        /* GORGEOUS SUCCESS OVERLAY */
        #overlay { position: fixed; inset: 0; background: radial-gradient(circle, #004d40 0%, #001a15 100%); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; text-align: center; padding: 20px; }
        .spinner-container { position: relative; width: 150px; height: 150px; margin-bottom: 30px; }
        .spinner-ring { position: absolute; inset: 0; border: 6px solid transparent; border-top-color: var(--success); border-bottom-color: var(--gold); border-radius: 50%; animation: spin-grow 2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; }
        
        /* ERROR MODAL */
        #error-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 25px; text-align: center; color: #333; width: 100%; max-width: 350px; border-top: 8px solid var(--error); }

        @keyframes spin-grow { 0% { transform: rotate(0deg) scale(0.8); } 50% { transform: rotate(180deg) scale(1.2); } 100% { transform: rotate(360deg) scale(0.8); } }
        .success-main { font-size: 2.2rem; font-weight: 900; color: white; margin: 0; letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="overlay">
    <div class="spinner-container"><div class="spinner-ring"></div></div>
    <h1 class="success-main">IDENTITY VERIFIED</h1>
    <p style="color:rgba(255,255,255,0.8); margin-top:10px; font-size:1.1rem;">Access Granted. Welcome back!</p>
    <p style="color:var(--gold); font-style:italic; margin-top:5px;">Redirecting to Dashboard...</p>
</div>

<div id="error-modal">
    <div class="modal-content">
        <h2 style="color:var(--error); margin-top:0;">Access Denied</h2>
        <p id="error-text" style="font-weight: 600;"></p>
        <button class="btn" style="background:var(--error); margin-top:10px;" onclick="closeError()">Try Again</button>
    </div>
</div>

<div class="container" id="scanner-ui" style="display:none;">
    <h2 style="color:var(--gold); margin-bottom: 5px;">NSUK SECURE LOGIN</h2>
    <div class="video-wrapper" id="ring-border"><video id="webcam" playsinline autoplay muted></video></div>
    <div id="status">POSITION FACE...</div>
</div>

<div class="container" id="login-ui">
    <div id="login-card">
        <h2 style="color:var(--nsuk); margin-top:0; text-align:center;">NSUK LOGIN</h2>
        <label>Matric Number</label>
        <input type="text" id="matric-login" placeholder="e.g. NSUK/SCI/001">
        <label>Password</label>
        <input type="password" id="pass-login" placeholder="••••••••">
        <button class="btn" onclick="startLoginProcess()">VERIFY IDENTITY</button>
    </div>
    <a href="registration.html" style="color:var(--gold); text-decoration:none; font-weight:700; margin-top:20px; display:block;">New Student? Register Profile</a>
</div>

<script>
Backendless.initApp('523BE897-EEB4-4213-B3C7-136526B902A6','A49A96D8-B93B-4793-AE1B-7766D0DA8E84');

const video = document.getElementById('webcam');
const statusText = document.getElementById('status');
const overlay = document.getElementById('overlay');

let isLocked = false, storedUser = null, authLoop;
let stableFrames = 0;

function showError(msg) {
    document.getElementById('error-text').innerText = msg;
    document.getElementById('error-modal').style.display = 'flex';
}
function closeError() { 
    document.getElementById('error-modal').style.display = 'none';
    if(!isLocked) location.reload();
}

async function startLoginProcess() {
    const m = document.getElementById('matric-login').value.trim();
    const p = document.getElementById('pass-login').value;

    if(!m || !p) return showError("Please enter your matric number and password.");

    try {
        const email = m.replace(/\//g, "") + "@nsuk.edu.ng";
        // 1. Authenticate with Backendless
        const user = await Backendless.UserService.login(email, p, true);
        storedUser = user;

        // 2. Transition to Camera
        document.getElementById('login-ui').style.display = 'none';
        document.getElementById('scanner-ui').style.display = 'block';

        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/vladmandic/face-api/model/';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);

        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        video.srcObject = stream;
        video.onloadedmetadata = () => { authLoop = setInterval(runBiometricMatch, 400); };

    } catch (e) { showError("Invalid Credentials. Please check your matric number and password."); }
}

async function runBiometricMatch() {
    if (isLocked || video.videoWidth === 0) return;

    const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320 }))
        .withFaceLandmarks().withFaceDescriptor();

    if (!det) {
        stableFrames = 0;
        statusText.innerText = "CENTER YOUR FACE";
        return;
    }

    // Secure Euclidean Match
    const storedDescriptor = new Float32Array(JSON.parse(storedUser.face_descriptor));
    const distance = faceapi.euclideanDistance(det.descriptor, storedDescriptor);

    if (distance < 0.45) { // Match Found
        stableFrames++;
        statusText.innerText = "MATCH FOUND! STAY STILL...";
        statusText.style.color = "#2ecc71";
        document.getElementById('ring-border').style.borderColor = "#2ecc71";
    } else {
        stableFrames = 0;
        statusText.innerText = "IDENTITY MISMATCH";
        statusText.style.color = "red";
        document.getElementById('ring-border').style.borderColor = "red";
    }

    if (stableFrames >= 5) {
        clearInterval(authLoop);
        isLocked = true;
        
        // Show Gorgeous Success Overlay
        overlay.style.display = "flex";
        
        localStorage.setItem("loggedUser", JSON.stringify(storedUser));
        setTimeout(() => { window.location.href = "dashboard.html"; }, 3500);
    }
}
</script>
</body>
</html>
