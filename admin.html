<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSUK Super-Admin Portal</title>
    <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --nsuk: #004d40; --gold: #ffc107; --bg: #f4f7f6; 
            --white: #ffffff; --danger: #ff5252; --success: #2ecc71;
            --glass: rgba(255, 255, 255, 0.95);
        }
        
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: #2c3e50; }

        /* NAVIGATION TABS */
        .master-nav {
            background: var(--nsuk); padding: 5px 20px; color: white;
            display: flex; justify-content: center; gap: 10px;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .nav-btn {
            background: none; border: none; color: rgba(255,255,255,0.7);
            padding: 15px 20px; cursor: pointer; font-weight: 800;
            font-size: 0.85rem; transition: 0.3s; border-bottom: 3px solid transparent;
            text-transform: uppercase;
        }
        .nav-btn.active { color: var(--gold); border-bottom-color: var(--gold); }

        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        /* PREMIUM UI ELEMENTS */
        .glass-card {
            background: var(--glass); backdrop-filter: blur(10px);
            padding: 30px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.05);
            margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.3);
        }
        .premium-header { 
            padding: 30px; border-radius: 30px; color: white; margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(135deg, var(--nsuk) 0%, #002d26 100%);
            transition: 0.5s;
        }
        .premium-header.offline { background: #455a64; }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { font-size: 0.75rem; font-weight: 800; color: var(--nsuk); margin-bottom: 5px; display: block; text-transform: uppercase; }
        input, select { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #eee; font-size: 0.9rem; box-sizing: border-box; background: #fafafa; }
        
        .btn-main { background: var(--nsuk); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,77,64,0.2); }

        /* ITEM CARDS */
        .faculty-tag { background: var(--nsuk); color: var(--gold); padding: 8px 15px; border-radius: 10px; display: inline-block; font-size: 0.7rem; font-weight: 900; margin: 25px 0 10px; }
        .item-card { background: white; padding: 18px 25px; border-radius: 20px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .item-card.active { border-left: 8px solid var(--success); background: #f0fff4; }

        /* LIVE FEED */
        .course-tabs { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; }
        .tab-chip { background: white; padding: 10px 20px; border-radius: 50px; font-size: 0.8rem; font-weight: 800; cursor: pointer; white-space: nowrap; border: 2px solid transparent; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-chip.active { background: var(--nsuk); color: white; border-color: var(--gold); }

        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 20px; }
        .student-card { background: white; border-radius: 25px; padding: 20px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.04); animation: popIn 0.4s ease; }
        .student-card img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 4px solid #f8f9fa; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 16px 35px; border-radius: 50px; background: #333; color: white; z-index: 9999; display: none; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<nav class="master-nav">
    <button class="nav-btn active" onclick="showTab('struct-tab', this)">University Structure</button>
    <button class="nav-btn" onclick="showTab('manage-tab', this)">Course Manager</button>
    <button class="nav-btn" onclick="showTab('feed-tab', this)">Live Attendance</button>
</nav>

<div class="container">
    
    <div id="struct-tab" class="tab-content active">
        <div class="glass-card">
            <h2 style="margin-top:0; color:var(--nsuk);">üèõÔ∏è Hierarchy Settings</h2>
            <div class="input-grid">
                <div>
                    <label>Faculty Name</label>
                    <input type="text" id="facultyName" placeholder="e.g. Natural Science">
                </div>
                <div>
                    <label>Department Name</label>
                    <input type="text" id="deptName" placeholder="e.g. Computer Science">
                </div>
            </div>
            <button class="btn-main" onclick="addStructure()">ADD TO STRUCTURE</button>
        </div>

        <div class="glass-card">
            <h2 style="margin-top:0; color:var(--nsuk);">üéì Academic Levels</h2>
            <div class="input-grid">
                <div>
                    <label>Level Name</label>
                    <input type="text" id="levelName" placeholder="e.g. 300 Level">
                </div>
                <div>
                    <label>Sort Order (Number)</label>
                    <input type="number" id="sortOrder" placeholder="e.g. 3">
                </div>
            </div>
            <button class="btn-main" style="background:var(--gold); color:var(--nsuk);" onclick="addLevel()">REGISTER LEVEL</button>
        </div>
    </div>

    <div id="manage-tab" class="tab-content">
        <div class="glass-card">
            <h2 style="margin-top:0; color: var(--nsuk);">üì¶ Course Publisher</h2>
            <div class="input-grid">
                <div><label>Faculty</label><select id="cFaculty" onchange="syncDepts()"><option value="">Loading...</option></select></div>
                <div><label>Department</label><select id="cDept"><option value="">Select Faculty</option></select></div>
            </div>
            <div class="input-grid">
                <div><label>Target Level</label><select id="cLevel"></select></div>
                <div><label>Course Code</label><input type="text" id="cCode" placeholder="CSC 3111"></div>
            </div>
            <label>Full Course Title</label>
            <input type="text" id="cTitle" placeholder="Operating Systems" style="margin-bottom: 20px;">
            <button class="btn-main" onclick="publishCourse()">PUBLISH TO SYSTEM</button>
        </div>
        <div id="courseListContainer"></div>
    </div>

    <div id="feed-tab" class="tab-content">
        <div class="premium-header offline" id="feedHeader">
            <div>
                <h1 id="feedTitle" style="margin:0; font-size: 1.8rem;">OFFLINE</h1>
                <p id="feedDetail" style="margin:5px 0 0; opacity: 0.9; font-weight: 500;">Select an active session below</p>
            </div>
            <div style="background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 50px; font-size: 0.75rem; font-weight: 900; border: 1.5px solid white;" id="feedBadge">SESSION CLOSED</div>
        </div>

        <div class="course-tabs" id="feedTabs"></div>

        <div class="glass-card" style="margin-top: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <b style="color:var(--nsuk); font-size: 1.1rem;">Verified Students: <span id="presentCount">0</span></b>
                <button onclick="exportToExcel()" style="background:#1d6f42; color:white; border:none; padding:10px 20px; border-radius:12px; cursor:pointer; font-weight:bold;">üìä Export Excel</button>
            </div>
            <input type="text" id="searchBox" placeholder="üîç Quick search..." style="margin-bottom: 20px; border-radius: 50px;" onkeyup="filterFeed()">
            <div class="student-grid" id="studentGrid"></div>
        </div>
    </div>

</div>

<div id="toast"></div>

<script>
Backendless.initApp('523BE897-EEB4-4213-B3C7-136526B902A6','A49A96D8-B93B-4793-AE1B-7766D0DA8E84');

let currentViewCode = "";
let processedSet = new Set();
let rawData = [];

function showTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    if(id === 'manage-tab') loadCourseList();
    if(id === 'feed-tab') refreshLiveSessions();
}

function notify(m, type = 'success') {
    const t = document.getElementById('toast');
    t.innerText = m; t.style.background = type === 'success' ? '#2ecc71' : '#ff5252';
    t.style.display = 'block'; setTimeout(() => t.style.display='none', 3000);
}

// --- STRUCTURE LOGIC ---
async function addStructure() {
    const f = document.getElementById('facultyName').value.trim();
    const d = document.getElementById('deptName').value.trim();
    if(!f || !d) return notify("Fill both fields", "error");
    try {
        await Backendless.Data.of("University_Structure").save({ faculty: f, department: d });
        notify("Structure Updated");
        document.getElementById('deptName').value = "";
        initDropdowns();
    } catch(e) { notify("Error saving structure", "error"); }
}

async function addLevel() {
    const l = document.getElementById('levelName').value.trim();
    const o = document.getElementById('sortOrder').value;
    if(!l || !o) return notify("Fill both fields", "error");
    try {
        await Backendless.Data.of("Academic_Levels").save({ level_name: l, sortOrder: parseInt(o) });
        notify("Level Registered");
        document.getElementById('levelName').value = "";
        initDropdowns();
    } catch(e) { notify("Error saving level", "error"); }
}

// --- COURSE LOGIC ---
async function initDropdowns() {
    try {
        const facs = await Backendless.Data.of("University_Structure").find(Backendless.DataQueryBuilder.create().setProperties("faculty").setGroupBy("faculty"));
        document.getElementById('cFaculty').innerHTML = '<option value="">-- Faculty --</option>' + facs.map(f => `<option value="${f.faculty}">${f.faculty}</option>`).join('');
        const lvls = await Backendless.Data.of("Academic_Levels").find(Backendless.DataQueryBuilder.create().setSortBy(["sortOrder ASC"]));
        document.getElementById('cLevel').innerHTML = lvls.map(l => `<option value="${l.level_name}">${l.level_name}</option>`).join('');
    } catch(e) {}
}

async function syncDepts() {
    const f = document.getElementById('cFaculty').value;
    if(!f) return;
    const res = await Backendless.Data.of("University_Structure").find(Backendless.DataQueryBuilder.create().setWhereClause(`faculty='${f}'`));
    document.getElementById('cDept').innerHTML = res.map(d => `<option value="${d.department}">${d.department}</option>`).join('');
}

async function loadCourseList() {
    try {
        const courses = await Backendless.Data.of("Courses").find(Backendless.DataQueryBuilder.create().setSortBy(["faculty ASC"]));
        const container = document.getElementById('courseListContainer');
        const grouped = courses.reduce((a, b) => { const k = b.faculty || "Other"; if(!a[k]) a[k]=[]; a[k].push(b); return a; }, {});
        let h = '';
        for(let f in grouped) {
            h += `<div class="faculty-tag">${f}</div>`;
            grouped[f].forEach(c => {
                h += `<div class="item-card ${c.isActive?'active':''}">
                    <div><b>${c.course_code}: ${c.course_name}</b><br><small>${c.department} ‚Ä¢ ${c.target_level}</small></div>
                    <div style="display:flex; gap:10px;">
                        <button style="background:${c.isActive?'#ff5252':'#2ecc71'}; color:white; border:none; padding:10px 20px; border-radius:12px; font-weight:bold; cursor:pointer;" 
                                onclick="toggleCourse('${c.objectId}', ${c.isActive})">${c.isActive?'STOP':'START'}</button>
                        <button onclick="deleteCourse('${c.objectId}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
        }
        container.innerHTML = h || '<p style="text-align:center; opacity:0.5;">No courses found.</p>';
    } catch(e) {}
}

async function publishCourse() {
    const d = {
        faculty: document.getElementById('cFaculty').value, department: document.getElementById('cDept').value,
        target_level: document.getElementById('cLevel').value, course_code: document.getElementById('cCode').value.trim(),
        course_name: document.getElementById('cTitle').value.trim(), isActive: false
    };
    if(!d.course_code || !d.course_name) return notify("Missing fields", "error");
    try {
        await Backendless.Data.of("Courses").save(d);
        notify("Published Successfully");
        document.getElementById('cCode').value = "";
        document.getElementById('cTitle').value = "";
        loadCourseList();
    } catch(e) { notify("Error publishing", "error"); }
}

async function toggleCourse(id, s) {
    try {
        await Backendless.Data.of("Courses").save({ objectId: id, isActive: !s });
        notify(!s ? "Session Active" : "Session Stopped");
        loadCourseList();
    } catch(e) {}
}

async function deleteCourse(id) {
    if(confirm("Permanently delete?")) { 
        try {
            await Backendless.Data.of("Courses").remove({ objectId: id }); 
            loadCourseList();
        } catch(e) {}
    }
}

// --- LIVE FEED LOGIC (DYNAMIC COUNTER INCLUDED) ---
async function refreshLiveSessions() {
    try {
        const active = await Backendless.Data.of("Courses").find(Backendless.DataQueryBuilder.create().setWhereClause("isActive = true"));
        const tabs = document.getElementById('feedTabs');
        const head = document.getElementById('feedHeader');
        const badge = document.getElementById('feedBadge');

        if(active.length === 0) {
            tabs.innerHTML = ""; currentViewCode = "";
            head.classList.add('offline');
            document.getElementById('feedTitle').innerText = "SESSION CLOSED";
            badge.innerText = "SESSION CLOSED"; //
            return;
        }

        head.classList.remove('offline');
        // UPDATED: Show dynamic count in badge
        badge.innerText = `${active.length} SESSION(S) LIVE`;

        tabs.innerHTML = active.map(c => `<div class="tab-chip ${currentViewCode === c.course_code ? 'active' : ''}" onclick="switchFeed('${c.course_code}', '${c.course_name}')">${c.course_code}</div>`).join('');
        if(!currentViewCode) switchFeed(active[0].course_code, active[0].course_name);
    } catch(e) {}
}

function switchFeed(code, name) {
    currentViewCode = code;
    document.getElementById('feedTitle').innerText = code;
    document.getElementById('feedDetail').innerText = name;
    document.getElementById('studentGrid').innerHTML = "";
    processedSet.clear();
    document.querySelectorAll('.tab-chip').forEach(t => t.classList.toggle('active', t.innerText === code));
    pollResults();
}

async function pollResults() {
    if(!currentViewCode) return;
    try {
        const query = Backendless.DataQueryBuilder.create().setWhereClause(`course_code = '${currentViewCode}'`).setSortBy(["lecture_date DESC"]);
        const records = await Backendless.Data.of("Attendance_Records").find(query);
        rawData = records;
        document.getElementById('presentCount').innerText = records.length;
        const grid = document.getElementById('studentGrid');
        for (const r of records) {
            if(!processedSet.has(r.objectId)) {
                processedSet.add(r.objectId);
                const user = await Backendless.Data.of("Users").find(Backendless.DataQueryBuilder.create().setWhereClause(`objectId = '${r.student_id}'`));
                const div = document.createElement('div');
                div.className = 'student-card';
                div.setAttribute('data-search', (r.student_name + r.matric_no).toLowerCase());
                div.innerHTML = `<img src="${user[0]?user[0].face_url:''}"><br><b style="color:var(--nsuk); font-size:0.9rem;">${r.student_name}</b><br><small style="font-weight:700; color:#888;">${r.matric_no.toUpperCase()}</small>`;
                grid.prepend(div);
            }
        }
    } catch(e) {}
}

function exportToExcel() {
    if(rawData.length === 0) return alert("No data to export!");
    const ws = XLSX.utils.json_to_sheet(rawData.map(r => ({ Name: r.student_name, Matric: r.matric_no, Time: new Date(r.lecture_date).toLocaleTimeString() })));
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Attendance");
    XLSX.writeFile(wb, `NSUK_Attendance_${currentViewCode}.xlsx`); //
}

function filterFeed() {
    const v = document.getElementById('searchBox').value.toLowerCase();
    document.querySelectorAll('.student-card').forEach(c => c.style.display = c.getAttribute('data-search').includes(v) ? 'block' : 'none');
}

// Initialize
initDropdowns();
setInterval(refreshLiveSessions, 10000); //
setInterval(pollResults, 4000);
</script>
</body>
</html>
